# 微前端本地调试

## 背景
前端现在分成了各个子应用
1. 基座应用对于子应用的开发团队来说没有代码权限，
2. 有时很多问题是在线上或者在于其他应用联动才会复现
3. 同时开发时需要和主应用或者其他子应用联动，需要提高开发效率
所以需要寻找到一种方法去调试一个已部署系统的部分前端代码的方式；

## 基础思路
利用代理针对静态资源请求的替换，将本身系统请求线上的页面替换为请求本地启动的应用；所以存在以下方式
1. 利用代理工具： Fildder, Charles, 此时不改变请求地址，在工具监听电脑的所有请求，并拦截部分请求进行重写(不限于url，请求头，请求参数等数据的重写)
2. 利用nginx配置代理：将nginx代理部署系统的地址，同时针对需要替换的资源进行代理配置，代理到本地；

## 操作步骤

### mac使用Charles工具步骤

例子背景： 利用workSpace的dev环境，TCall子应用为例，进行配置；

线上环境：https://tient-dev.c****.cn;       
TCall线上环境：https://tient-tcall-dev.c****.cn;        
TCall本地环境: http://localhost:9000;       

1. 第一步：下载Charles,进行安装;
2. 第二步：进行代理设置，开启代理http/https/websocket监听及需要监听的请求；如下图

<div style="backgroud: #000">
    <img style="height: 600px" src="./technology/imgs/代理设置1.png">
</div>
<hr/>
<div style="backgroud: #000">
    <img style="height: 400px" src="./technology/imgs/代理设置2.png">
</div>

3. 第三步：安装charles证书
<div style="backgroud: #000">
    <img style="height: 400px" src="./technology/imgs/安装证书.png">
</div>

4. 第四步: 开启代理设置，开启后随意请求个网页，看是否监控到请求，如下图

<div style="backgroud: #000">
    <img style="height: 400px" src="./technology/imgs/代理开启.png">
</div>

5. 第五步：进去重写请求页面

<div style="backgroud: #000">
    <img style="height: 400px" src="./technology/imgs/重写请求1.png">
</div>

6. 第六步: 重写请求，如下三图即可

<div style="backgroud: #000">
    <img style="height: 400px" src="./technology/imgs/重写请求-具体-1.png">
</div>
<hr/>
需要重写请求TCall的线上地址
<div style="backgroud: #000">
    <img style="height: 400px" src="./technology/imgs/重写请求-具体-2.png">
</div>
<hr/>
配置重写规则，点击确定即可
<div style="backgroud: #000">
    <img style="height: 400px" src="./technology/imgs/重写请求-具体-3.png">
</div>


7: 此时，打开网页访问线上环境，此时如果会访问TCall线上环境皆会代理到本地环境

#### 使用注意
1. 当charles监听被关闭或者电脑睡眠后，有时监听不生效，不断的进行第四步进行开启关闭测试即可
2. 当在TCall使用vue+vite时，在线上环境请求本地环境会出现无限不断刷新问题，需要配置devServer中的ws信息，如下代码：

在vite.config.ts中配置，端口(port)和域名(host)可以任意，但是必须设置
```
......
server: {
    host: '127.0.0.1',
    port: 9000,
    hmr: {
      protocol: 'ws',
      host: '127.0.0.1',
    },
    open: false, //vite项目启动时自动打开浏览器
    headers: {
      'Access-Control-Allow-Origin': '*',
    },
....

```


